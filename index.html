<!doctype html>
<html lang="hu" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#065f46">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Infektológia Tankönyv</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- <script src="_sdk/element_sdk.js"></script> -->
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600;700&amp;family=Source+Sans+3:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    .font-serif-book { font-family: 'Crimson Pro', Georgia, serif; }
    .font-sans-book { font-family: 'Source Sans 3', system-ui, sans-serif; }
    
    .disease-card {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .disease-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .tab-btn.active {
      border-bottom: 3px solid currentColor;
      font-weight: 600;
    }
    
    .section-header {
      position: relative;
      padding-left: 16px;
    }
    .section-header::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      border-radius: 2px;
    }
    
    .info-card {
      border-left: 4px solid;
    }
    
    .pathogen-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .scroll-area {
      scrollbar-width: thin;
    }
    .scroll-area::-webkit-scrollbar {
      width: 6px;
    }
    .scroll-area::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
    }
    .scroll-area::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.4s ease forwards;
    }
    
    .category-pill {
      transition: all 0.2s ease;
    }
    .category-pill:hover {
      transform: scale(1.02);
    }
    .category-pill.active {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .category-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <!-- <script src="_sdk/data_sdk.js" type="text/javascript"></script> -->
 </head>
 <body class="h-full font-sans-book bg-slate-50 text-slate-800">
  <div id="app" class="h-full w-full flex flex-col overflow-hidden"><!-- Header -->
   <header class="bg-gradient-to-r from-emerald-800 via-emerald-700 to-teal-700 text-white px-6 py-5 shadow-lg flex-shrink-0">
    <div class="max-w-7xl mx-auto">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
        <svg class="w-7 h-7" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" /> <path d="M12 6v6l4 2" /> <circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.3" /> <path d="M8 8l1.5 1.5M16 8l-1.5 1.5M8 16l1.5-1.5M16 16l-1.5-1.5" />
        </svg>
       </div>
       <div>
        <h1 id="main-title" class="font-serif-book text-2xl font-bold tracking-tight">Infektológia Tankönyv</h1>
        <p id="main-subtitle" class="text-emerald-100 text-sm mt-0.5">Orvostanhallgatók számára</p>
        <div class="text-emerald-200 text-xs mt-1">
         <p>Írta és szerkesztette: Dr. Péterfi Zoltán</p>
         <p>Copyright: 2026. Dr. Péterfi Zoltán | Verzió: 2.1</p>
        </div>
       </div>
      </div>
      <div class="flex items-center gap-2 ml-4">
        <button onclick="changeLanguage('hu')" class="p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-colors group" title="Magyar">
          <img src="https://flagcdn.com/w40/hu.png" alt="HU" class="w-6 h-4 rounded-sm shadow-sm opacity-90 group-hover:opacity-100 transition-opacity">
        </button>
        <button onclick="changeLanguage('en')" class="p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-colors group" title="English">
          <img src="https://flagcdn.com/w40/gb.png" alt="EN" class="w-6 h-4 rounded-sm shadow-sm opacity-90 group-hover:opacity-100 transition-opacity">
        </button>
        <button onclick="changeLanguage('de')" class="p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-colors group" title="Deutsch">
          <img src="https://flagcdn.com/w40/de.png" alt="DE" class="w-6 h-4 rounded-sm shadow-sm opacity-90 group-hover:opacity-100 transition-opacity">
        </button>
      </div>
      <div class="flex items-center gap-4">
       <button onclick="exportPDF()" id="export-pdf-btn" class="px-4 py-2 rounded-lg bg-white/15 border border-white/20 text-white text-sm hover:bg-white/25 transition-colors flex items-center gap-2" title="A teljes tartalom nyomtatása/mentése PDF-be">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
        <span>Export PDF</span>
       </button>
       <div class="relative"><input type="text" id="search-input" placeholder="Keresés betegségek között..." class="w-64 px-4 py-2 pl-10 rounded-lg bg-white/15 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:bg-white/25 focus:border-white/40 transition-all text-sm">
        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-white/60" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
       </div>
      </div>
     </div>
    </div>
   </header>
   <!-- Main Content -->
   <div class="flex-1 flex overflow-hidden"><!-- Sidebar - Disease Categories -->
    <aside id="sidebar" class="w-56 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 transition-all duration-300 ease-in-out">
     <div class="h-14 flex items-center justify-between px-4 border-b border-slate-100 overflow-hidden">
      <h2 id="sidebar-title" class="font-semibold text-slate-700 text-sm uppercase tracking-wider whitespace-nowrap transition-all duration-300">Betegségcsoportok</h2>
      <button onclick="toggleSidebar()" class="p-1.5 rounded-lg hover:bg-slate-100 text-slate-500 transition-colors flex-shrink-0" title="Oldalsáv váltása">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
      </button>
     </div>
     <nav id="category-nav" class="flex-1 overflow-y-auto scroll-area p-3 space-y-2"><!-- Categories rendered by JS -->
     </nav>
    </aside><!-- Disease List -->
    <div id="disease-list-panel" class="w-56 bg-slate-50 border-r border-slate-200 flex flex-col flex-shrink-0">
     <div class="p-4 border-b border-slate-100 bg-white">
      <h2 id="category-title" class="font-semibold text-slate-800">Válasszon kategóriát</h2>
      <p id="disease-count" class="text-sm text-slate-500 mt-1"></p>
     </div>
     <div id="disease-list" class="flex-1 overflow-y-auto scroll-area p-3 space-y-2"><!-- Diseases rendered by JS -->
     </div>
    </div><!-- Disease Detail -->
    <main id="disease-detail" class="flex-1 overflow-y-auto scroll-area bg-white">
     <div id="welcome-screen" class="h-full flex items-center justify-center">
      <div class="text-center max-w-md px-6">
       <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-emerald-100 to-teal-100 rounded-full flex items-center justify-center">
        <svg class="w-12 h-12 text-emerald-600" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12h6m-3-3v6m-7 4h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
       </div>
       <h2 class="font-serif-book text-2xl font-bold text-slate-800 mb-3">Üdvözöljük az Infektológia Tankönyvben</h2>
       <p class="text-slate-600 leading-relaxed">Válasszon egy betegségcsoportot a bal oldali menüből, majd egy konkrét betegséget a részletes klinikai információk megtekintéséhez.</p>
      </div>
     </div>
     <div id="disease-content" class="hidden"><!-- Disease details rendered by JS -->
     </div>
    </main>
   </div>
  </div>

  <!-- Score Calculator Modal -->
  <div id="score-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300" id="score-modal-panel">
      <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
        <h3 id="score-modal-title" class="font-semibold text-slate-800">Score Kalkulátor</h3>
        <button onclick="closeScoreModal()" class="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="score-modal-content" class="p-6 overflow-y-auto">
        <!-- Dynamic content -->
      </div>
      <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end">
        <button onclick="closeScoreModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors font-medium">Bezárás</button>
      </div>
    </div>
  </div>

  <script>
    // Globális tároló inicializálása
    window.diseases = {};
  </script>

  <script src="metadata.js"></script>

  <script>
    /**
     * A teljes adatbázis PDF exportálása a kiválasztott nyelven.
     * Tartalmazza a szerzőt, copyrightot és verziószámot.
     */
    function exportPDF() {
        // Ellenőrizzük, hogy az adatbázis betöltődött-e
        if (!window.diseases) {
            alert('Az adatbázis nem elérhető.');
            return;
        }

        // Nyelv detektálása a betöltött adatok alapján
        let lang = 'hu';
        if (typeof currentLanguage !== 'undefined') {
            lang = currentLanguage;
        } else {
            const testName = window.diseases.bacterial_respiratory?.name || '';
            if (testName.includes('Respiratory')) lang = 'en';
            else if (testName.includes('Atemweg')) lang = 'de';
        }

        // Szövegek a nyelv függvényében
        const texts = {
            hu: { 
                title: "Infectologia Adatbázis", author: "Szerző", date: "Dátum", version: "Verzió", 
                pathogen: "Kórokozó", 
                epidemiology: "Epidemiológia", incidence: "Incidencia", seasonality: "Szezonalitás", transmission: "Transzmisszió", risk_groups: "Rizikócsoportok",
                pathomechanism: "Pathomechanizmus", steps: "Lépések", virulence: "Virulencia faktorok",
                clinical: "Klinikum", incubation: "Inkubáció", onset: "Kezdet", symptoms: "Tünetek", physical: "Fizikális vizsgálat", complications: "Komplikációk",
                diagnostics: "Diagnosztika", laboratory: "Labor", imaging: "Képalkotó", microbiology: "Mikrobiológia", criteria: "Kritériumok",
                differential: "Differenciáldiagnózis",
                therapy: "Terápia", empirical: "Empirikus", targeted: "Célzott", supportive: "Szupportív", prevention: "Prevenció", guidelines: "Irányelvek", drug: "Gyógyszer", dose: "Dózis", note: "Megjegyzés",
                prognosis: "Prognózis", mortality: "Mortalitás", factors: "Faktorok", scores: "Score-ok",
                table_test: "Vizsgálat", table_finding: "Eredmény", table_interpretation: "Értelmezés"
            },
            en: { 
                title: "Infectology Database", author: "Author", date: "Date", version: "Version", 
                pathogen: "Pathogen", 
                epidemiology: "Epidemiology", incidence: "Incidence", seasonality: "Seasonality", transmission: "Transmission", risk_groups: "Risk Groups",
                pathomechanism: "Pathomechanism", steps: "Steps", virulence: "Virulence Factors",
                clinical: "Clinical Features", incubation: "Incubation", onset: "Onset", symptoms: "Symptoms", physical: "Physical Exam", complications: "Complications",
                diagnostics: "Diagnostics", laboratory: "Laboratory", imaging: "Imaging", microbiology: "Microbiology", criteria: "Criteria",
                differential: "Differential Diagnosis",
                therapy: "Therapy", empirical: "Empirical", targeted: "Targeted", supportive: "Supportive", prevention: "Prevention", guidelines: "Guidelines", drug: "Drug", dose: "Dose", note: "Note",
                prognosis: "Prognosis", mortality: "Mortality", factors: "Factors", scores: "Scores",
                table_test: "Test", table_finding: "Finding", table_interpretation: "Interpretation"
            },
            de: { 
                title: "Infektiologie Datenbank", author: "Autor", date: "Datum", version: "Version", 
                pathogen: "Erreger", 
                epidemiology: "Epidemiologie", incidence: "Inzidenz", seasonality: "Saisonalität", transmission: "Übertragung", risk_groups: "Risikogruppen",
                pathomechanism: "Pathomechanismus", steps: "Schritte", virulence: "Virulenzfaktoren",
                clinical: "Klinik", incubation: "Inkubation", onset: "Beginn", symptoms: "Symptome", physical: "Körperliche Untersuchung", complications: "Komplikationen",
                diagnostics: "Diagnostik", laboratory: "Labor", imaging: "Bildgebung", microbiology: "Mikrobiologie", criteria: "Kriterien",
                differential: "Differentialdiagnose",
                therapy: "Therapie", empirical: "Empirisch", targeted: "Gezielt", supportive: "Supportiv", prevention: "Prävention", guidelines: "Leitlinien", drug: "Medikament", dose: "Dosis", note: "Hinweis",
                prognosis: "Prognose", mortality: "Mortalität", factors: "Faktoren", scores: "Scores",
                table_test: "Test", table_finding: "Befund", table_interpretation: "Interpretation"
            }
        };
        const t = texts[lang] || texts.hu;

        // Metadata
        const meta = {
            authorName: "Dr. Péterfi Zoltán",
            copyright: "© 2024 Dr. Péterfi Zoltán",
            versionNum: "1.0"
        };

        // Új ablak nyitása a nyomtatáshoz
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert('A felugró ablakok tiltva vannak. Kérlek engedélyezd őket az exporthoz.');
            return;
        }
        
        let htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>${t.title}</title>
                <style>
                    @page { size: A4; margin: 1.5cm; }
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.4; color: #333; padding: 20px; max-width: 1000px; margin: 0 auto; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0 0 10px 0; color: #2c3e50; }
                    .meta { font-size: 0.9em; color: #555; }
                    
                    /* Kategória stílusok */
                    .category { margin-top: 30px; }
                    .category:first-of-type { page-break-before: auto; }
                    .category-header { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }
                    .category-title { font-size: 1.6em; color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px; }
                    
                    /* Betegség kártya stílusok */
                    .disease { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; }
                    .disease h3 { margin-top: 0; margin-bottom: 10px; color: #e11d48; border-bottom: 1px solid #e11d48; padding-bottom: 5px; display: inline-block; }
                    
                    .section { margin-bottom: 8px; }
                    .label { font-weight: bold; color: #444; }
                    .sub-label { font-weight: 600; color: #555; text-decoration: underline; margin-top: 5px; display: block; }
                    
                    /* Táblázat stílusok */
                    table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85em; background: white; }
                    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: top; }
                    th { background-color: #e9ecef; font-weight: bold; }
                    
                    ul { margin: 5px 0; padding-left: 20px; }
                    li { margin-bottom: 2px; }

                    .footer { margin-top: 40px; text-align: center; font-size: 0.8em; color: #999; border-top: 1px solid #eee; padding-top: 10px; }
                    
                    @media print {
                        body { padding: 0; max-width: none; width: 100%; }
                        .disease { border: 1px solid #ccc; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>${t.title}</h1>
                    <div class="meta">
                        <p><strong>${t.author}:</strong> ${meta.authorName} &nbsp;|&nbsp; <strong>Copyright:</strong> ${meta.copyright}</p>
                        <p><strong>${t.version}:</strong> ${meta.versionNum} &nbsp;|&nbsp; <strong>${t.date}:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
        `;

        // Helper functions
        const renderList = (items) => {
            if (!items || items.length === 0) return '';
            return `<ul>${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
        };

        // Adatok iterálása (Kategóriák -> Betegségek)
        for (const [catKey, category] of Object.entries(window.diseases)) {
            htmlContent += `
                <div class="category">
                    <div class="category-header">
                        <h2 class="category-title" style="color: ${category.color || '#2c3e50'}">${category.icon || ''} ${category.name}</h2>
                    </div>
            `;

            if (category.diseases) {
                category.diseases.forEach(disease => {
                    htmlContent += `<div class="disease"><h3>${disease.name}</h3>`;

                    // Kórokozó
                    if (disease.pathogen) {
                        htmlContent += `<div class="section"><span class="label">${t.pathogen}:</span> ${disease.pathogen.type} - ${disease.pathogen.name} ${disease.pathogen.gram ? `(${disease.pathogen.gram})` : ''}</div>`;
                    }

                    // Epidemiológia
                    if (disease.epidemiology) {
                        htmlContent += `<div class="section"><span class="label">${t.epidemiology}:</span>`;
                        if (disease.epidemiology.incidence) htmlContent += `<div>- ${t.incidence}: ${disease.epidemiology.incidence}</div>`;
                        if (disease.epidemiology.seasonality) htmlContent += `<div>- ${t.seasonality}: ${disease.epidemiology.seasonality}</div>`;
                        if (disease.epidemiology.transmission) htmlContent += `<div>- ${t.transmission}: ${disease.epidemiology.transmission}</div>`;
                        if (disease.epidemiology.risk_groups && disease.epidemiology.risk_groups.length > 0) {
                            htmlContent += `<div>- ${t.risk_groups}: ${disease.epidemiology.risk_groups.join(', ')}</div>`;
                        }
                        htmlContent += `</div>`;
                    }

                    // Pathomechanizmus
                    if (disease.pathomechanism) {
                        htmlContent += `<div class="section"><span class="label">${t.pathomechanism}:</span>`;
                        if (disease.pathomechanism.steps && disease.pathomechanism.steps.length > 0) {
                            htmlContent += `<div class="sub-label">${t.steps}:</div>${renderList(disease.pathomechanism.steps)}`;
                        }
                        if (disease.pathomechanism.virulence_factors && disease.pathomechanism.virulence_factors.length > 0) {
                            htmlContent += `<div class="sub-label">${t.virulence}:</div>${renderList(disease.pathomechanism.virulence_factors)}`;
                        }
                        htmlContent += `</div>`;
                    }

                    // Klinikum
                    if (disease.clinical) {
                        htmlContent += `<div class="section"><span class="label">${t.clinical}:</span>`;
                        if (disease.clinical.incubation) htmlContent += `<div>- ${t.incubation}: ${disease.clinical.incubation}</div>`;
                        if (disease.clinical.onset) htmlContent += `<div>- ${t.onset}: ${disease.clinical.onset}</div>`;
                        
                        if (disease.clinical.symptoms && disease.clinical.symptoms.length > 0) {
                            htmlContent += `<div class="sub-label">${t.symptoms}:</div><ul>`;
                            disease.clinical.symptoms.forEach(s => {
                                htmlContent += `<li><strong>${s.name}:</strong> ${s.description}</li>`;
                            });
                            htmlContent += `</ul>`;
                        }
                        
                        if (disease.clinical.physical_exam && disease.clinical.physical_exam.length > 0) {
                            htmlContent += `<div class="sub-label">${t.physical}:</div>${renderList(disease.clinical.physical_exam)}`;
                        }
                        if (disease.clinical.complications && disease.clinical.complications.length > 0) {
                            htmlContent += `<div class="sub-label">${t.complications}:</div>${renderList(disease.clinical.complications)}`;
                        }
                        htmlContent += `</div>`;
                    }

                    // Diagnosztika
                    if (disease.diagnostics) {
                        htmlContent += `<div class="section"><span class="label">${t.diagnostics}:</span>`;
                        
                        if (disease.diagnostics.criteria && disease.diagnostics.criteria.length > 0) {
                            htmlContent += `<div class="sub-label">${t.criteria}:</div>`;
                            disease.diagnostics.criteria.forEach(c => {
                                htmlContent += `<div><strong>${c.name}:</strong> ${c.items.join(', ')}</div>`;
                            });
                        }

                        if (disease.diagnostics.laboratory && disease.diagnostics.laboratory.length > 0) {
                            htmlContent += `<div class="sub-label">${t.laboratory}:</div>`;
                            htmlContent += `<table><tr><th>${t.table_test || 'Vizsgálat'}</th><th>${t.table_finding || 'Eredmény'}</th><th>${t.table_interpretation || 'Értelmezés'}</th></tr>`;
                            disease.diagnostics.laboratory.forEach(l => {
                                htmlContent += `<tr><td>${l.test}</td><td>${l.finding}</td><td>${l.interpretation}</td></tr>`;
                            });
                            htmlContent += `</table>`;
                        }

                        if (disease.diagnostics.imaging && disease.diagnostics.imaging.length > 0) {
                            htmlContent += `<div class="sub-label">${t.imaging}:</div><ul>`;
                            disease.diagnostics.imaging.forEach(img => {
                                htmlContent += `<li><strong>${img.modality}:</strong> ${img.finding} <em>(${img.significance})</em></li>`;
                            });
                            htmlContent += `</ul>`;
                        }

                        if (disease.diagnostics.microbiology && disease.diagnostics.microbiology.length > 0) {
                            htmlContent += `<div class="sub-label">${t.microbiology}:</div><ul>`;
                            disease.diagnostics.microbiology.forEach(m => {
                                htmlContent += `<li><strong>${m.test}:</strong> ${m.finding} <em>(${m.significance})</em></li>`;
                            });
                            htmlContent += `</ul>`;
                        }
                        htmlContent += `</div>`;
                    }

                    // Differenciáldiagnózis
                    const diffList = disease.differential || disease.diagnostics?.differential || [];
                    if (diffList.length > 0) {
                        htmlContent += `<div class="section"><span class="label">${t.differential}:</span><ul>`;
                        diffList.forEach(d => {
                            htmlContent += `<li><strong>${d.disease}:</strong> ${d.distinguishing}</li>`;
                        });
                        htmlContent += `</ul></div>`;
                    }

                    // Terápia táblázatos megjelenítése
                    if (disease.therapy) {
                        htmlContent += `<div class="section"><span class="label">${t.therapy}:</span>`;
                        
                        if (disease.therapy.guidelines && disease.therapy.guidelines.length > 0) {
                            htmlContent += `<div><strong>${t.guidelines}:</strong> ${disease.therapy.guidelines.join(', ')}</div>`;
                        }

                        if (disease.therapy.empirical) {
                            const empirical = disease.therapy.empirical;
                        
                        // Helper a gyógyszerek táblázatos megjelenítéséhez
                        const renderDrugsTable = (drugs) => {
                            if (!drugs || !Array.isArray(drugs)) return '';
                            let rows = drugs.map(d => `<tr><td style="width:30%"><strong>${d.drug}</strong></td><td style="width:25%">${d.dose}</td><td>${d.note || ''}</td></tr>`).join('');
                            return `<table><tr><th>${t.drug}</th><th>${t.dose}</th><th>${t.note}</th></tr>${rows}</table>`;
                        };

                        // Kezeljük a különböző adatstruktúrákat (tömb vagy objektum kulcsokkal)
                        if (!Array.isArray(empirical)) {
                            for (const [key, value] of Object.entries(empirical)) {
                                let title = key;
                                let drugs = [];
                                
                                // Ha a value egy tömb (pl. outpatient: [...])
                                if (Array.isArray(value)) {
                                    // Cím formázása (pl. outpatient -> Outpatient)
                                    title = key.charAt(0).toUpperCase() + key.slice(1);
                                    drugs = value;
                                } 
                                // Ha a value egy objektum (pl. cap_outpatient: { title: '...', drugs: [...] })
                                else if (value.title && value.drugs) {
                                    title = value.title;
                                    drugs = value.drugs;
                                }
                                
                                if (drugs.length > 0) {
                                    htmlContent += `<div class="section"><span class="label">${title}:</span>${renderDrugsTable(drugs)}</div>`;
                                }
                            }
                        }
                    }

                        if (disease.therapy.targeted) {
                            htmlContent += `<div class="sub-label">${t.targeted}:</div><div>${disease.therapy.targeted}</div>`;
                        }

                        if (disease.therapy.supportive && disease.therapy.supportive.length > 0) {
                            htmlContent += `<div class="sub-label">${t.supportive}:</div>${renderList(disease.therapy.supportive)}`;
                        }

                        if (disease.therapy.prevention && disease.therapy.prevention.length > 0) {
                            htmlContent += `<div class="sub-label">${t.prevention}:</div>${renderList(disease.therapy.prevention)}`;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `</div>`; // End disease
                });
            }
            htmlContent += `</div>`; // End category
        }

        htmlContent += `
            <div class="footer">Generálva / Generated: ${new Date().toLocaleString()}</div>
            <script>
                window.onload = function() { 
                    // Kis késleltetés a rendereléshez, majd nyomtatás
                    setTimeout(function() { window.print(); }, 500); 
                }
            <\/script>
            </body></html>
        `;

        printWindow.document.write(htmlContent);
        printWindow.document.close();
    }

    const defaultConfig = {
      app_title: 'Infektológia Tankönyv',
      subtitle: 'Orvostanhallgatók számára',
      primary_color: '#065f46',
      secondary_color: '#f0fdf4',
      text_color: '#1e293b',
      accent_color: '#0d9488',
      surface_color: '#ffffff'
    };

    let config = { ...defaultConfig };

    // State
    let selectedCategory = null;
    let selectedDisease = null;
    let activeTab = 'epidemiology';
    let isSidebarCollapsed = false;

    // DOM Elements
    const categoryNav = document.getElementById('category-nav');
    const diseaseList = document.getElementById('disease-list');
    const diseaseDetail = document.getElementById('disease-detail');
    const categoryTitle = document.getElementById('category-title');
    const diseaseCount = document.getElementById('disease-count');
    const welcomeScreen = document.getElementById('welcome-screen');
    const diseaseContent = document.getElementById('disease-content');
    const searchInput = document.getElementById('search-input');

    // Language handling
    let currentLanguage = 'hu';
    const languageFiles = {
      hu: ['Thorax.js', 'abdomen.js', 'BoneandSST.js', 'CNS.js', 'STD.js', 'parazita.js', 'zoonozis.js', 'systemic.js', 'tropical.js', 'emerging.js', 'childhood.js'],
      en: ['Thorax_en.js', 'abdomen_en.js', 'BoneandSST_en.js', 'CNS_en.js', 'STD_en.js', 'parazita_en.js', 'zoonozis_en.js', 'systemic_en.js', 'tropical_en.js', 'emerging_en.js', 'childhood_en.js'],
      de: ['thorax_de.js', 'abdomen_de.js', 'BoneandSST_de.js', 'CNS_de.js', 'STD_de.js', 'parazita_de.js', 'zoonozis_de.js', 'systemic_de.js', 'tropical_de.js', 'emerging_de.js', 'childhood_de.js']
    };

    const translations = {
      hu: {
        app_title: 'Infektológia Tankönyv',
        subtitle: 'Orvostanhallgatók számára',
        sidebar_title: 'Betegségcsoportok',
        select_category: 'Válasszon kategóriát',
        disease_count: 'betegség',
        welcome_title: 'Üdvözöljük az Infektológia Tankönyvben',
        welcome_text: 'Válasszon egy betegségcsoportot a bal oldali menüből, majd egy konkrét betegséget a részletes klinikai információk megtekintéséhez.',
        search_placeholder: 'Keresés betegségek között...',
        no_results: 'Nincs találat',
        search_results: 'Keresési eredmények',
        tabs: {
          epidemiology: 'Epidemiológia',
          pathomechanism: 'Pathomechanizmus',
          clinical: 'Klinikum',
          diagnostics: 'Diagnosztika',
          differential: 'Diff. diagnózis',
          therapy: 'Terápia',
          prognosis: 'Prognózis',
          gallery: 'Galéria'
        },
        section_epidemiology: 'Epidemiológiai jellemzők',
        label_incidence: 'Incidencia',
        label_seasonality: 'Szezonalitás',
        label_risk_groups: 'Rizikócsoportok',
        label_transmission: 'Transzmisszió',
        section_pathomechanism: 'Pathomechanizmus',
        label_pathogenesis_steps: 'Patogenezis lépései',
        label_virulence_factors: 'Virulencia faktorok',
        label_incubation: 'Inkubáció',
        label_onset: 'Kezdet',
        label_complications_count: 'Komplikációk',
        label_types: 'típus',
        section_symptoms: 'Tünetek',
        section_physical_exam: 'Fizikális vizsgálat',
        section_complications: 'Komplikációk',
        section_diagnostic_criteria: 'Diagnosztikus kritériumok',
        section_laboratory: 'Laboratóriumi vizsgálatok',
        table_test: 'Vizsgálat',
        table_finding: 'Eredmény',
        table_interpretation: 'Értelmezés',
        no_lab_tests: 'Nincs specifikus laboratóriumi vizsgálat.',
        section_imaging: 'Képalkotó vizsgálatok',
        no_imaging: 'Nincs specifikus képalkotó vizsgálat.',
        section_microbiology: 'Mikrobiológiai diagnosztika',
        no_microbiology: 'Nincs specifikus mikrobiológiai vizsgálat.',
        section_differential: 'Differenciáldiagnózis',
        label_distinguishing: 'Megkülönböztető jelek: ',
        no_differential: 'Nincs specifikus differenciáldiagnózis.',
        section_empirical_therapy: 'Empirikus terápia',
        label_supportive_therapy: 'Szupportív terápia',
        label_prevention: 'Prevenció',
        label_guidelines: 'Kezelési irányelvek',
        section_prognosis: 'Prognózis',
        label_mortality: 'Mortalitás',
        label_prognostic_scores: 'Prognosztikai score-ok',
        label_prognostic_factors: 'Prognosztikai faktorok',
        section_gallery: 'Kép Galéria',
        therapy_titles: {
            outpatient: 'Ambuláns kezelés',
            inpatient: 'Kórházi kezelés',
            icu: 'Intenzív osztályos kezelés',
            cap_outpatient: 'CAP - Ambuláns kezelés',
            cap_inpatient: 'CAP - Kórházi kezelés',
            cap_icu: 'CAP - Intenzív osztályos kezelés',
            hap_early: 'Nozokomiális pneumonia - Korai',
            hap_late_vap: 'Nozokomiális (késői) / VAP',
            default: 'Terápia'
        }
      },
      en: {
        app_title: 'Infectious Diseases Textbook',
        subtitle: 'For Medical Students',
        sidebar_title: 'Disease Categories',
        select_category: 'Select a Category',
        disease_count: 'diseases',
        welcome_title: 'Welcome to the Infectious Diseases Textbook',
        welcome_text: 'Select a disease category from the left menu, then a specific disease to view detailed clinical information.',
        search_placeholder: 'Search diseases...',
        no_results: 'No results found',
        search_results: 'Search Results',
        tabs: {
          epidemiology: 'Epidemiology',
          pathomechanism: 'Pathogenesis',
          clinical: 'Clinical',
          diagnostics: 'Diagnostics',
          differential: 'Diff. Diagnosis',
          therapy: 'Management',
          prognosis: 'Prognosis',
          gallery: 'Gallery'
        },
        section_epidemiology: 'Epidemiological Features',
        label_incidence: 'Incidence',
        label_seasonality: 'Seasonality',
        label_risk_groups: 'Risk Groups',
        label_transmission: 'Transmission',
        section_pathomechanism: 'Pathomechanism',
        label_pathogenesis_steps: 'Pathogenesis Steps',
        label_virulence_factors: 'Virulence Factors',
        label_incubation: 'Incubation',
        label_onset: 'Onset',
        label_complications_count: 'Complications',
        label_types: 'types',
        section_symptoms: 'Symptoms',
        section_physical_exam: 'Physical Examination',
        section_complications: 'Complications',
        section_diagnostic_criteria: 'Diagnostic Criteria',
        section_laboratory: 'Laboratory Tests',
        table_test: 'Test',
        table_finding: 'Finding',
        table_interpretation: 'Interpretation',
        no_lab_tests: 'No specific laboratory tests.',
        section_imaging: 'Imaging Studies',
        no_imaging: 'No specific imaging studies.',
        section_microbiology: 'Microbiological Diagnostics',
        no_microbiology: 'No specific microbiological diagnostics.',
        section_differential: 'Differential Diagnosis',
        label_distinguishing: 'Distinguishing features: ',
        no_differential: 'No specific differential diagnosis.',
        section_empirical_therapy: 'Empirical Therapy',
        label_supportive_therapy: 'Supportive Therapy',
        label_prevention: 'Prevention',
        label_guidelines: 'Treatment Guidelines',
        section_prognosis: 'Prognosis',
        label_mortality: 'Mortality',
        label_prognostic_scores: 'Prognostic Scores',
        label_prognostic_factors: 'Prognostic Factors',
        section_gallery: 'Image Gallery',
        therapy_titles: {
            outpatient: 'Outpatient Treatment',
            inpatient: 'Inpatient Treatment',
            icu: 'Intensive Care',
            cap_outpatient: 'CAP - Outpatient',
            cap_inpatient: 'CAP - Inpatient',
            cap_icu: 'CAP - ICU',
            hap_early: 'HAP - Early',
            hap_late_vap: 'HAP - Late / VAP',
            default: 'Therapy'
        }
      },
      de: {
        app_title: 'Lehrbuch der Infektiologie',
        subtitle: 'Für Medizinstudenten',
        sidebar_title: 'Krankheitskategorien',
        select_category: 'Wählen Sie eine Kategorie',
        disease_count: 'Krankheiten',
        welcome_title: 'Willkommen im Lehrbuch der Infektiologie',
        welcome_text: 'Wählen Sie eine Krankheitskategorie aus dem linken Menü und dann eine bestimmte Krankheit, um detaillierte klinische Informationen anzuzeigen.',
        search_placeholder: 'Krankheiten suchen...',
        no_results: 'Keine Ergebnisse gefunden',
        search_results: 'Suchergebnisse',
        tabs: {
          epidemiology: 'Epidemiologie',
          pathomechanism: 'Pathomechanismus',
          clinical: 'Klinik',
          diagnostics: 'Diagnostik',
          differential: 'Diff. Diagnose',
          therapy: 'Therapie',
          prognosis: 'Prognose',
          gallery: 'Galerie'
        },
        section_epidemiology: 'Epidemiologische Merkmale',
        label_incidence: 'Inzidenz',
        label_seasonality: 'Saisonalität',
        label_risk_groups: 'Risikogruppen',
        label_transmission: 'Übertragung',
        section_pathomechanism: 'Pathomechanismus',
        label_pathogenesis_steps: 'Schritte der Pathogenese',
        label_virulence_factors: 'Virulenzfaktoren',
        label_incubation: 'Inkubation',
        label_onset: 'Beginn',
        label_complications_count: 'Komplikationen',
        label_types: 'Typen',
        section_symptoms: 'Symptome',
        section_physical_exam: 'Körperliche Untersuchung',
        section_complications: 'Komplikationen',
        section_diagnostic_criteria: 'Diagnostische Kriterien',
        section_laboratory: 'Laboruntersuchungen',
        table_test: 'Test',
        table_finding: 'Befund',
        table_interpretation: 'Interpretation',
        no_lab_tests: 'Keine spezifischen Laboruntersuchungen.',
        section_imaging: 'Bildgebende Verfahren',
        no_imaging: 'Keine spezifischen bildgebenden Verfahren.',
        section_microbiology: 'Mikrobiologische Diagnostik',
        no_microbiology: 'Keine spezifische mikrobiologische Diagnostik.',
        section_differential: 'Differentialdiagnose',
        label_distinguishing: 'Unterscheidungsmerkmale: ',
        no_differential: 'Keine spezifische Differentialdiagnose.',
        section_empirical_therapy: 'Empirische Therapie',
        label_supportive_therapy: 'Supportive Therapie',
        label_prevention: 'Prävention',
        label_guidelines: 'Behandlungsleitlinien',
        section_prognosis: 'Prognose',
        label_mortality: 'Mortalität',
        label_prognostic_scores: 'Prognose-Scores',
        label_prognostic_factors: 'Prognosefaktoren',
        section_gallery: 'Bildergalerie',
        therapy_titles: {
            outpatient: 'Ambulante Behandlung',
            inpatient: 'Stationäre Behandlung',
            icu: 'Intensivbehandlung',
            cap_outpatient: 'CAP - Ambulant',
            cap_inpatient: 'CAP - Stationär',
            cap_icu: 'CAP - Intensivstation',
            hap_early: 'HAP - Früh',
            hap_late_vap: 'HAP - Spät / VAP',
            default: 'Therapie'
        }
      }
    };

    function updateUIStrings(lang) {
      const t = translations[lang];
      document.getElementById('main-title').textContent = t.app_title;
      document.getElementById('main-subtitle').textContent = t.subtitle;
      document.getElementById('sidebar-title').textContent = t.sidebar_title;
      document.getElementById('search-input').placeholder = t.search_placeholder;
      
      // Update welcome screen if visible
      const welcomeTitle = document.querySelector('#welcome-screen h2');
      const welcomeText = document.querySelector('#welcome-screen p');
      if (welcomeTitle) welcomeTitle.textContent = t.welcome_title;
      if (welcomeText) welcomeText.textContent = t.welcome_text;

      // Update category title if no disease selected or just category selected
      if (!selectedDisease) {
         const catTitle = document.getElementById('category-title');
         if (!selectedCategory) {
             catTitle.textContent = t.select_category;
         } else if (window.diseases[selectedCategory]) {
             // If category is selected, we keep the category name, but update the count text suffix if needed
             // Actually renderDiseaseList handles the count text update
         }
      }
      
      // Re-render lists to update texts like "No results" or disease counts
      if (selectedCategory) {
          renderDiseaseList();
      } else {
          // If no category selected, reset the list view text
          document.getElementById('disease-list').innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${t.select_category}</p>`;
          document.getElementById('category-title').textContent = t.select_category;
      }

      // Re-render detail view to update tabs and section headers
      if (selectedDisease) {
          renderDiseaseDetail();
      }
    }

    async function loadLanguageFiles(lang) {
      window.diseases = {}; // Clear existing data
      const files = languageFiles[lang];
      
      const promises = files.map(file => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = file;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      });

      try {
        await Promise.all(promises);
        normalizeDiseases();
        updateUIStrings(lang);
        renderCategories();
        // If a category/disease was selected, try to re-select it (if IDs match across languages)
        if (selectedCategory) {
            if (window.diseases[selectedCategory]) {
                renderDiseaseList();
                if (selectedDisease) {
                    const cat = window.diseases[selectedCategory];
                    if (cat.diseases.find(d => d.id === selectedDisease)) {
                        renderDiseaseDetail();
                    } else {
                        selectedDisease = null;
                        diseaseContent.classList.add('hidden');
                        welcomeScreen.classList.remove('hidden');
                    }
                }
            } else {
                selectedCategory = null;
                selectedDisease = null;
                diseaseList.innerHTML = ''; // Clear list if category not found
                diseaseContent.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
            }
        }
      } catch (error) {
        console.error("Error loading language files:", error);
        alert("Hiba történt a nyelvi fájlok betöltésekor.");
      }
    }

    window.changeLanguage = function(lang) {
        if (currentLanguage === lang) return;
        currentLanguage = lang;
        loadLanguageFiles(lang);
    };

    // Score Calculators Data
    const scoreCalculators = {
      'CURB-65': {
        title: 'CURB-65 Score (Pneumonia)',
        description: 'Közösségben szerzett tüdőgyulladás súlyosságának és a betegfelvétel szükségességének megítélésére.',
        items: [
          { id: 'c', label: 'Confusion (Zavartság)', points: 1 },
          { id: 'u', label: 'Urea > 7 mmol/L (Se. karbamid)', points: 1 },
          { id: 'r', label: 'Respiratory rate ≥ 30/perc (Légzésszám)', points: 1 },
          { id: 'b', label: 'Blood pressure (Szisztolés < 90 vagy Diasztolés ≤ 60 Hgmm)', points: 1 },
          { id: '65', label: 'Életkor ≥ 65 év', points: 1 }
        ],
        interpret: (score) => {
          if (score <= 1) return { risk: 'Alacsony rizikó (0-1)', action: 'Otthoni kezelés megfontolható', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' };
          if (score === 2) return { risk: 'Közepes rizikó (2)', action: 'Kórházi felvétel javasolt', color: 'text-amber-600', bg: 'bg-amber-50', border: 'border-amber-200' };
          return { risk: 'Magas rizikó (3-5)', action: 'Sürgős kórházi/ITO felvétel', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' };
        }
      },
      'qSOFA': {
        title: 'qSOFA Score (Sepsis)',
        description: 'Gyors ágy melletti eszköz a szepszis gyanújának felvetésére (quick SOFA).',
        items: [
          { id: 'rr', label: 'Légzésszám ≥ 22/perc', points: 1 },
          { id: 'ams', label: 'Megváltozott mentális státusz (GCS < 15)', points: 1 },
          { id: 'sbp', label: 'Szisztolés vérnyomás ≤ 100 Hgmm', points: 1 }
        ],
        interpret: (score) => {
          if (score < 2) return { risk: 'Alacsony valószínűség (<2)', action: 'Monitorozás, klinikai megítélés', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' };
          return { risk: 'Magas rizikó (≥2)', action: 'Szepszis gyanúja, további kivizsgálás (SOFA)', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' };
        }
      },
      'ATLAS': {
        title: 'ATLAS Score (C. difficile)',
        description: 'Clostridioides difficile fertőzés súlyosságának és a mortalitás kockázatának becslése.',
        items: [
          { type: 'header', label: 'Életkor' },
          { type: 'radio', name: 'atlas_age', label: '< 60 év', points: 0, checked: true },
          { type: 'radio', name: 'atlas_age', label: '60 - 79 év', points: 1 },
          { type: 'radio', name: 'atlas_age', label: '≥ 80 év', points: 2 },
          { type: 'header', label: 'Klinikum és Labor' },
          { type: 'checkbox', label: 'Szisztémás antibiotikum kezelés a CDI terápia alatt', points: 1 },
          { type: 'header', label: 'Leukocyta szám (G/L)' },
          { type: 'radio', name: 'atlas_wbc', label: '< 16', points: 0, checked: true },
          { type: 'radio', name: 'atlas_wbc', label: '16 - 25', points: 1 },
          { type: 'radio', name: 'atlas_wbc', label: '> 25', points: 2 },
          { type: 'header', label: 'Albumin (g/L)' },
          { type: 'radio', name: 'atlas_alb', label: '> 35', points: 0, checked: true },
          { type: 'radio', name: 'atlas_alb', label: '26 - 35', points: 1 },
          { type: 'radio', name: 'atlas_alb', label: '≤ 25', points: 2 },
          { type: 'header', label: 'Kreatinin (µmol/L)' },
          { type: 'radio', name: 'atlas_crea', label: '≤ 120', points: 0, checked: true },
          { type: 'radio', name: 'atlas_crea', label: '121 - 179', points: 1 },
          { type: 'radio', name: 'atlas_crea', label: '≥ 180', points: 2 }
        ],
        interpret: (score) => {
          if (score <= 2) return { risk: 'Enyhe (0-2 pont)', action: '0% mortalitás, >95% gyógyulás', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' };
          if (score <= 5) return { risk: 'Közepes (3-5 pont)', action: 'Mortalitás növekszik', color: 'text-amber-600', bg: 'bg-amber-50', border: 'border-amber-200' };
          return { risk: 'Súlyos (6-7 pont)', action: 'Magas mortalitás, intenzív terápia mérlegelendő', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' };
        }
      },
      'SOFA': {
        title: 'SOFA Score (Sepsis)',
        description: 'Szervelégtelenség mértékének megítélése (Sequential Organ Failure Assessment).',
        items: [
          { type: 'header', label: 'Légzés (PaO2/FiO2 Hgmm)' },
          { type: 'radio', name: 'sofa_resp', label: '≥ 400', points: 0, checked: true },
          { type: 'radio', name: 'sofa_resp', label: '< 400', points: 1 },
          { type: 'radio', name: 'sofa_resp', label: '< 300', points: 2 },
          { type: 'radio', name: 'sofa_resp', label: '< 200 (lélegeztetve)', points: 3 },
          { type: 'radio', name: 'sofa_resp', label: '< 100 (lélegeztetve)', points: 4 },
          { type: 'header', label: 'Véralvadás (Thrombocyta G/L)' },
          { type: 'radio', name: 'sofa_plt', label: '≥ 150', points: 0, checked: true },
          { type: 'radio', name: 'sofa_plt', label: '< 150', points: 1 },
          { type: 'radio', name: 'sofa_plt', label: '< 100', points: 2 },
          { type: 'radio', name: 'sofa_plt', label: '< 50', points: 3 },
          { type: 'radio', name: 'sofa_plt', label: '< 20', points: 4 },
          { type: 'header', label: 'Máj (Bilirubin µmol/L)' },
          { type: 'radio', name: 'sofa_bili', label: '< 20', points: 0, checked: true },
          { type: 'radio', name: 'sofa_bili', label: '20 - 32', points: 1 },
          { type: 'radio', name: 'sofa_bili', label: '33 - 101', points: 2 },
          { type: 'radio', name: 'sofa_bili', label: '102 - 204', points: 3 },
          { type: 'radio', name: 'sofa_bili', label: '> 204', points: 4 },
          { type: 'header', label: 'Keringés (MAP / Vazopresszorok)' },
          { type: 'radio', name: 'sofa_cv', label: 'MAP ≥ 70 Hgmm', points: 0, checked: true },
          { type: 'radio', name: 'sofa_cv', label: 'MAP < 70 Hgmm', points: 1 },
          { type: 'radio', name: 'sofa_cv', label: 'Dopamin ≤ 5 vagy Dobutamin', points: 2 },
          { type: 'radio', name: 'sofa_cv', label: 'Dopamin > 5 vagy Noradrenalin ≤ 0.1', points: 3 },
          { type: 'radio', name: 'sofa_cv', label: 'Dopamin > 15 vagy Noradrenalin > 0.1', points: 4 },
          { type: 'header', label: 'Központi idegrendszer (GCS)' },
          { type: 'radio', name: 'sofa_gcs', label: '15', points: 0, checked: true },
          { type: 'radio', name: 'sofa_gcs', label: '13 - 14', points: 1 },
          { type: 'radio', name: 'sofa_gcs', label: '10 - 12', points: 2 },
          { type: 'radio', name: 'sofa_gcs', label: '6 - 9', points: 3 },
          { type: 'radio', name: 'sofa_gcs', label: '< 6', points: 4 },
          { type: 'header', label: 'Vese (Kreatinin µmol/L)' },
          { type: 'radio', name: 'sofa_ren', label: '< 110', points: 0, checked: true },
          { type: 'radio', name: 'sofa_ren', label: '110 - 170', points: 1 },
          { type: 'radio', name: 'sofa_ren', label: '171 - 299', points: 2 },
          { type: 'radio', name: 'sofa_ren', label: '300 - 440 (vagy <500ml vizelet)', points: 3 },
          { type: 'radio', name: 'sofa_ren', label: '> 440 (vagy <200ml vizelet)', points: 4 }
        ],
        interpret: (score) => {
          return { risk: `Összpontszám: ${score}`, action: 'A pontszám növekedése romló prognózist jelez. Sepszis definíció: fertőzés + SOFA változás ≥2.', color: 'text-slate-800', bg: 'bg-slate-50', border: 'border-slate-200' };
        }
      },
      'PORT': {
        title: 'Pneumonia Severity Index (PSI/PORT)',
        description: 'Közösségben szerzett tüdőgyulladás (CAP) rizikóbecslése.',
        items: [
          { type: 'header', label: 'Demográfia' },
          { type: 'number', label: 'Életkor (év)', points: 1, min: 0, max: 120 },
          { type: 'checkbox', label: 'Nőnemű beteg', points: -10 },
          { type: 'checkbox', label: 'Otthonlakó / Intézeti gondozott', points: 10 },
          { type: 'header', label: 'Társbetegségek' },
          { type: 'checkbox', label: 'Daganatos betegség', points: 30 },
          { type: 'checkbox', label: 'Májbetegség', points: 20 },
          { type: 'checkbox', label: 'Szívelégtelenség (CHF)', points: 10 },
          { type: 'checkbox', label: 'Cerebrovascularis betegség', points: 10 },
          { type: 'checkbox', label: 'Vesebetegség', points: 10 },
          { type: 'header', label: 'Fizikális vizsgálat' },
          { type: 'checkbox', label: 'Megváltozott mentális státusz', points: 20 },
          { type: 'checkbox', label: 'Légzésszám ≥ 30/perc', points: 20 },
          { type: 'checkbox', label: 'Szisztolés RR < 90 Hgmm', points: 20 },
          { type: 'checkbox', label: 'Testhőmérséklet < 35°C vagy > 40°C', points: 15 },
          { type: 'checkbox', label: 'Pulzus ≥ 125/perc', points: 10 },
          { type: 'header', label: 'Laboratóriumi és Képalkotó leletek' },
          { type: 'checkbox', label: 'Artériás pH < 7.35', points: 30 },
          { type: 'checkbox', label: 'BUN > 10.7 mmol/L (Urea > 30 mg/dL)', points: 20 },
          { type: 'checkbox', label: 'Nátrium < 130 mmol/L', points: 20 },
          { type: 'checkbox', label: 'Glükóz > 13.9 mmol/L', points: 10 },
          { type: 'checkbox', label: 'Hematokrit < 30%', points: 10 },
          { type: 'checkbox', label: 'PaO2 < 60 Hgmm (vagy SpO2 < 90%)', points: 10 },
          { type: 'checkbox', label: 'Pleuralis folyadék', points: 10 }
        ],
        interpret: (score) => {
          if (score <= 50) return { risk: 'I. Osztály (≤50)', action: 'Alacsony rizikó (0.1% mortalitás). Otthoni kezelés.', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' };
          if (score <= 70) return { risk: 'II. Osztály (51-70)', action: 'Alacsony rizikó (0.6% mortalitás). Otthoni kezelés.', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' };
          if (score <= 90) return { risk: 'III. Osztály (71-90)', action: 'Közepes rizikó (0.9-2.8%). Rövid kórházi megfigyelés vagy otthoni.', color: 'text-amber-600', bg: 'bg-amber-50', border: 'border-amber-200' };
          if (score <= 130) return { risk: 'IV. Osztály (91-130)', action: 'Magas rizikó (8-9%). Kórházi felvétel.', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200' };
          return { risk: 'V. Osztály (>130)', action: 'Nagyon magas rizikó (27-30%). Kórházi/ITO felvétel.', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' };
        }
      },
      'APACHE II': {
        title: 'APACHE II Score',
        description: 'Súlyossági pontrendszer intenzív osztályos betegeknél (Acute Physiology and Chronic Health Evaluation II).',
        items: [
          { type: 'header', label: 'Életkor' },
          { type: 'radio', name: 'ap_age', label: '≤ 44', points: 0, checked: true },
          { type: 'radio', name: 'ap_age', label: '45 - 54', points: 2 },
          { type: 'radio', name: 'ap_age', label: '55 - 64', points: 3 },
          { type: 'radio', name: 'ap_age', label: '65 - 74', points: 5 },
          { type: 'radio', name: 'ap_age', label: '≥ 75', points: 6 },
          { type: 'header', label: 'Krónikus Egészségi Állapot' },
          { type: 'checkbox', label: 'Súlyos szervelégtelenség (máj, szív, légző, vese) vagy immunszuppresszió', points: 5 },
          { type: 'checkbox', label: 'Sürgősségi műtét után vagy nem műtéti beteg', points: 0 }, 
          { type: 'header', label: 'Akut Fiziológiai Paraméterek (Legrosszabb érték az első 24 órában)' },
          { type: 'header', label: 'Hőmérséklet (°C)' },
          { type: 'radio', name: 'ap_temp', label: '36 - 38.4', points: 0, checked: true },
          { type: 'radio', name: 'ap_temp', label: '34 - 35.9 vagy 38.5 - 38.9', points: 1 },
          { type: 'radio', name: 'ap_temp', label: '32 - 33.9', points: 2 },
          { type: 'radio', name: 'ap_temp', label: '30 - 31.9 vagy 39 - 40.9', points: 3 },
          { type: 'radio', name: 'ap_temp', label: '≤ 29.9 vagy ≥ 41', points: 4 },
          { type: 'header', label: 'MAP (Középnyomás Hgmm)' },
          { type: 'radio', name: 'ap_map', label: '70 - 109', points: 0, checked: true },
          { type: 'radio', name: 'ap_map', label: '110 - 129 vagy 50 - 69', points: 2 },
          { type: 'radio', name: 'ap_map', label: '130 - 159', points: 3 },
          { type: 'radio', name: 'ap_map', label: '≥ 160 vagy ≤ 49', points: 4 },
          { type: 'header', label: 'Pulzus (/perc)' },
          { type: 'radio', name: 'ap_hr', label: '70 - 109', points: 0, checked: true },
          { type: 'radio', name: 'ap_hr', label: '55 - 69 vagy 110 - 139', points: 2 },
          { type: 'radio', name: 'ap_hr', label: '40 - 54 vagy 140 - 179', points: 3 },
          { type: 'radio', name: 'ap_hr', label: '≤ 39 vagy ≥ 180', points: 4 },
          { type: 'header', label: 'Légzésszám (/perc)' },
          { type: 'radio', name: 'ap_rr', label: '12 - 24', points: 0, checked: true },
          { type: 'radio', name: 'ap_rr', label: '10 - 11 vagy 25 - 34', points: 1 },
          { type: 'radio', name: 'ap_rr', label: '6 - 9', points: 2 },
          { type: 'radio', name: 'ap_rr', label: '35 - 49', points: 3 },
          { type: 'radio', name: 'ap_rr', label: '≤ 5 vagy ≥ 50', points: 4 },
          { type: 'header', label: 'Oxigenizáció (AaDO2 vagy PaO2)' },
          { type: 'radio', name: 'ap_ox', label: 'Normál', points: 0, checked: true },
          { type: 'radio', name: 'ap_ox', label: 'Enyhe romlás', points: 1 },
          { type: 'radio', name: 'ap_ox', label: 'Közepes romlás', points: 3 },
          { type: 'radio', name: 'ap_ox', label: 'Súlyos romlás', points: 4 },
          { type: 'header', label: 'Artériás pH' },
          { type: 'radio', name: 'ap_ph', label: '7.33 - 7.49', points: 0, checked: true },
          { type: 'radio', name: 'ap_ph', label: 'Eltérés', points: 2 },
          { type: 'radio', name: 'ap_ph', label: 'Jelentős eltérés (<7.15 vagy >7.7)', points: 4 },
          { type: 'header', label: 'Szérum Nátrium (mmol/L)' },
          { type: 'radio', name: 'ap_na', label: '130 - 149', points: 0, checked: true },
          { type: 'radio', name: 'ap_na', label: 'Eltérés', points: 1 },
          { type: 'radio', name: 'ap_na', label: 'Jelentős eltérés', points: 4 },
          { type: 'header', label: 'Szérum Kálium (mmol/L)' },
          { type: 'radio', name: 'ap_k', label: '3.5 - 5.4', points: 0, checked: true },
          { type: 'radio', name: 'ap_k', label: 'Eltérés', points: 1 },
          { type: 'radio', name: 'ap_k', label: 'Jelentős eltérés', points: 4 },
          { type: 'header', label: 'Szérum Kreatinin (mg/dL)' },
          { type: 'radio', name: 'ap_cr', label: '0.6 - 1.4', points: 0, checked: true },
          { type: 'radio', name: 'ap_cr', label: '< 0.6 vagy 1.5 - 1.9', points: 2 },
          { type: 'radio', name: 'ap_cr', label: '2.0 - 3.4', points: 3 },
          { type: 'radio', name: 'ap_cr', label: '≥ 3.5', points: 4 },
          { type: 'checkbox', label: 'Akut veseelégtelenség (Kreatinin pontszám duplázódik)', points: 0 }, 
          { type: 'header', label: 'Hematokrit (%)' },
          { type: 'radio', name: 'ap_hct', label: '30 - 45.9', points: 0, checked: true },
          { type: 'radio', name: 'ap_hct', label: 'Eltérés', points: 2 },
          { type: 'radio', name: 'ap_hct', label: 'Jelentős eltérés', points: 4 },
          { type: 'header', label: 'Fehérvérsejt (G/L)' },
          { type: 'radio', name: 'ap_wbc', label: '3 - 14.9', points: 0, checked: true },
          { type: 'radio', name: 'ap_wbc', label: 'Eltérés', points: 2 },
          { type: 'radio', name: 'ap_wbc', label: 'Jelentős eltérés', points: 4 },
          { type: 'header', label: 'Glasgow Coma Scale (GCS)' },
          { type: 'number', label: 'GCS pontszám (15 - GCS = pont)', points: -1, min: 3, max: 15, value: 15 } 
        ],
        interpret: (score) => {
          // APACHE II score calculation usually involves adding (15 - GCS) to the total. 
          // Here we use a trick: base score includes 15, and GCS input subtracts from it.
          // Wait, simpler: GCS points = 15 - Actual GCS.
          // My input logic adds: value * multiplier. So if input is 15, multiplier -1 -> -15.
          // Total needs to be adjusted. Let's handle this in the logic or just ask for "Points for GCS" (15-GCS).
          // Better: Ask for GCS and handle logic? No, generic logic.
          // Let's change input to: "GCS pontveszteség (15 - GCS)" -> input 0 to 12.
          // Or keep generic.
          // Let's assume the user enters the GCS value, and I set points: -1. Then I need to add 15 to the base.
          // To keep it generic, I will ask for "15 mínusz GCS" value.
          return { risk: `APACHE II Score: ${score + 15}`, action: 'A mortalitás a pontszámmal korrelál (pl. 25 pont ~50% halálozás).', color: 'text-slate-800', bg: 'bg-slate-50', border: 'border-slate-200' };
        }
      }
    };

    // Score calculator function
    window.openScoreCalculator = function(scoreName) {
      const modal = document.getElementById('score-modal');
      const panel = document.getElementById('score-modal-panel');
      const title = document.getElementById('score-modal-title');
      const content = document.getElementById('score-modal-content');
      
      // Normalize name (remove extra text if present in button)
      const key = Object.keys(scoreCalculators).find(k => scoreName.includes(k)) || scoreName;
      const calc = scoreCalculators[key];
      
      if (!calc) {
        alert(`A(z) ${scoreName} kalkulátor jelenleg nem elérhető ebben az alkalmazásban.`);
        return;
      }
      
      title.textContent = calc.title;
      
      let html = `<p class="text-sm text-slate-500 mb-4 italic">${calc.description}</p>`;
      html += `<div class="space-y-2 mb-6">`;
      
      calc.items.forEach(item => {
        if (item.type === 'header') {
            html += `<h4 class="font-semibold text-slate-700 mt-4 mb-2 text-sm uppercase tracking-wide border-b border-slate-100 pb-1">${item.label}</h4>`;
        } else if (item.type === 'number') {
            html += `
              <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                <span class="text-slate-700 font-medium text-sm">${item.label}</span>
                <input type="number" class="w-20 px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:border-emerald-500 score-input" 
                  data-points="${item.points}" min="${item.min || 0}" max="${item.max || 999}" value="${item.value || ''}" placeholder="0">
              </div>
            `;
        } else if (item.type === 'radio') {
            html += `
              <label class="flex items-start gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors select-none mb-1">
                <div class="flex items-center h-5">
                  <input type="radio" name="${item.name}" class="w-4 h-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 score-input" data-points="${item.points}" ${item.checked ? 'checked' : ''}>
                </div>
                <span class="text-slate-700 font-medium text-sm">${item.label}</span>
              </label>
            `;
        } else {
            // Default checkbox
            html += `
              <label class="flex items-start gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors select-none">
                <div class="flex items-center h-5">
                  <input type="checkbox" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 border-gray-300 score-input" data-points="${item.points}">
                </div>
                <span class="text-slate-700 font-medium text-sm">${item.label}</span>
              </label>
            `;
        }
      });
      
      html += `</div>`;
      html += `
        <div id="score-result-container" class="bg-slate-100 rounded-xl p-4 text-center border border-slate-200 transition-colors duration-300">
          <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Eredmény</div>
          <div class="text-3xl font-bold text-slate-800 mb-1" id="score-result">0</div>
          <div class="font-bold text-lg" id="score-interpretation">-</div>
          <div class="text-sm text-slate-600 mt-1" id="score-action">-</div>
        </div>
      `;
      
      content.innerHTML = html;
      
      // Add event listeners
      const inputs = content.querySelectorAll('.score-input');
      inputs.forEach(input => {
        input.addEventListener('input', () => calculateScore(calc)); // Changed to 'input' for immediate number update
      });
      
      // Show modal
      modal.classList.remove('hidden');
      // Small delay for transition
      setTimeout(() => {
        modal.classList.remove('opacity-0');
        panel.classList.remove('scale-95');
        panel.classList.add('scale-100');
      }, 10);
      
      calculateScore(calc); // Initial calc
    };

    window.closeScoreModal = function() {
      const modal = document.getElementById('score-modal');
      const panel = document.getElementById('score-modal-panel');
      
      modal.classList.add('opacity-0');
      panel.classList.remove('scale-100');
      panel.classList.add('scale-95');
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    };

    function calculateScore(calc) {
      const container = document.getElementById('score-modal-content');
      let total = 0;
      
      // Checkboxes
      container.querySelectorAll('input[type="checkbox"]').forEach(input => {
        if (input.checked) total += parseFloat(input.dataset.points || 0);
      });

      // Radios
      container.querySelectorAll('input[type="radio"]:checked').forEach(input => {
        total += parseFloat(input.dataset.points || 0);
      });

      // Number inputs
      container.querySelectorAll('input[type="number"]').forEach(input => {
        const val = parseFloat(input.value) || 0;
        const multiplier = parseFloat(input.dataset.points || 1);
        total += val * multiplier;
      });
      
      const resultContainer = document.getElementById('score-result-container');
      const resultEl = document.getElementById('score-result');
      const interpEl = document.getElementById('score-interpretation');
      const actionEl = document.getElementById('score-action');
      
      // Special handling for APACHE II GCS logic (15 - GCS)
      // My input logic does: total += GCS * -1. So total is -GCS.
      // I need to add 15 to the display if it's APACHE II.
      // Or simpler: The interpret function handles the offset.
      // For APACHE II, interpret adds 15.
      
      if (calc.title.includes('APACHE II')) {
          displayScore = total + 15;
      }
      
      resultEl.textContent = displayScore;
      
      if (calc.interpret) {
        const interpretation = calc.interpret(total);
        interpEl.textContent = interpretation.risk;
        interpEl.className = `font-bold text-lg ${interpretation.color}`;
        actionEl.textContent = interpretation.action;
        
        // Update container style
        resultContainer.className = `rounded-xl p-4 text-center border transition-colors duration-300 ${interpretation.bg} ${interpretation.border}`;
      }
    };

    // Render categories
    function renderCategories() {
      categoryNav.innerHTML = Object.entries(diseases).map(([key, category]) => `
        <div class="category-item" draggable="true" data-id="${key}">
          <button onclick="selectCategory('${key}')" 
            class="category-pill w-full flex items-center ${isSidebarCollapsed ? 'justify-center px-2' : 'gap-3 px-4 text-left'} py-3 rounded-xl transition-all ${selectedCategory === key ? 'active text-white' : 'bg-slate-50 hover:bg-slate-100 text-slate-700'}"
            style="${selectedCategory === key ? `background: ${category.color}` : ''}"
            title="${category.name}">
            <span class="text-2xl pointer-events-none">${category.icon}</span>
            ${!isSidebarCollapsed ? `<span class="font-medium text-sm leading-tight pointer-events-none">${category.name}</span>` : ''}
          </button>
        </div>
      `).join('');
      setupDragAndDrop();
    }

    // Select category
    window.selectCategory = function(categoryKey) {
      selectedCategory = categoryKey;
      selectedDisease = null;

      renderCategories();
      renderDiseaseList();
      // A részletes nézetet csak akkor frissítjük, ha betegséget választanak
      diseaseContent.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
    };

    // Toggle sidebar
    window.toggleSidebar = function() {
      isSidebarCollapsed = !isSidebarCollapsed;
      const sidebar = document.getElementById('sidebar');
      const sidebarTitle = document.getElementById('sidebar-title');
      
      if (isSidebarCollapsed) {
        sidebar.classList.remove('w-56');
        sidebar.classList.add('w-20');
        sidebarTitle.classList.add('opacity-0', 'w-0', 'px-0');
      } else {
        sidebar.classList.remove('w-20');
        sidebar.classList.add('w-56');
        sidebarTitle.classList.remove('opacity-0', 'w-0', 'px-0');
      }
      renderCategories();
    };

    // Drag and Drop functionality
    function setupDragAndDrop() {
      const draggables = document.querySelectorAll('.category-item');
      const container = document.getElementById('category-nav');

      draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => {
          draggable.classList.add('dragging');
        });

        draggable.addEventListener('dragend', () => {
          draggable.classList.remove('dragging');
          updateDiseaseOrder();
        });
      });

      container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.dragging');
        if (afterElement == null) {
          container.appendChild(draggable);
        } else {
          container.insertBefore(draggable, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.category-item:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateDiseaseOrder() {
      const newOrder = [...document.querySelectorAll('.category-item')].map(el => el.dataset.id);
      const newDiseases = {};
      newOrder.forEach(key => {
        if (window.diseases[key]) newDiseases[key] = window.diseases[key];
      });
      window.diseases = newDiseases;
    }

    // Render disease list
    function renderDiseaseList() {
      const t = translations[currentLanguage];
      if (!selectedCategory) {
        diseaseList.innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${t.select_category}</p>`;
        categoryTitle.textContent = t.select_category;
        diseaseCount.textContent = '';
        return;
      }

      const category = diseases[selectedCategory];
      categoryTitle.textContent = category.name;
      diseaseCount.textContent = `${category.diseases.length} ${t.disease_count}`;

      diseaseList.innerHTML = category.diseases.map(disease => `
        <button onclick="selectDisease('${disease.id}')" 
          class="disease-card w-full text-left p-3.5 rounded-xl border transition-all group ${selectedDisease === disease.id ? 'border-emerald-500 bg-emerald-50 shadow-md ring-1 ring-emerald-500/20' : 'border-slate-100 bg-white shadow-sm hover:border-emerald-200'}">
          <div class="flex items-start gap-3.5">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white flex-shrink-0 shadow-sm transition-transform group-hover:scale-105" style="background: ${category.color}">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </div>
            <div class="flex-1 min-w-0 py-0.5">
              <h3 class="font-semibold text-slate-800 text-sm leading-tight group-hover:text-emerald-700 transition-colors">${disease.name}</h3>
              <p class="text-xs text-slate-500 mt-1 truncate group-hover:text-slate-600 transition-colors">${disease.pathogen.name}</p>
            </div>
          </div>
        </button>
      `).join('');
    }

    // Select disease
    window.selectDisease = function(diseaseId) {
      selectedDisease = diseaseId;
      activeTab = 'epidemiology';
      renderDiseaseList();
      renderDiseaseDetail();
    };

    // Change tab
    window.changeTab = function(tab) {
      activeTab = tab;
      renderDiseaseDetail();
    };

    // Get severity dot color
    function getSeverityDotColor(severity) {
      switch(severity) {
        case 'severe': return 'bg-red-500';
        case 'moderate': return 'bg-amber-500';
        case 'mild': return 'bg-green-500';
        default: return 'bg-slate-400';
      }
    }

    // Helper for therapy card styling to work with Tailwind JIT
    function getTherapyColorClasses(color) {
      const classMap = {
        green: {
          bg: 'bg-gradient-to-br from-green-50 to-green-100/50', border: 'border-green-200', text: 'text-green-800',
          drugBorder: 'border-green-200', drugText: 'text-green-800', drugDose: 'text-green-700',
          durationBg: 'bg-green-100', durationText: 'text-green-700', noteText: 'text-green-600'
        },
        blue: {
          bg: 'bg-gradient-to-br from-blue-50 to-blue-100/50', border: 'border-blue-200', text: 'text-blue-800',
          drugBorder: 'border-blue-200', drugText: 'text-blue-800', drugDose: 'text-blue-700',
          durationBg: 'bg-blue-100', durationText: 'text-blue-700', noteText: 'text-blue-600'
        },
        red: {
          bg: 'bg-gradient-to-br from-red-50 to-red-100/50', border: 'border-red-200', text: 'text-red-800',
          drugBorder: 'border-red-200', drugText: 'text-red-800', drugDose: 'text-red-700',
          durationBg: 'bg-red-100', durationText: 'text-red-700', noteText: 'text-red-600'
        },
        amber: {
          bg: 'bg-gradient-to-br from-amber-50 to-amber-100/50', border: 'border-amber-200', text: 'text-amber-800',
          drugBorder: 'border-amber-200', drugText: 'text-amber-800', drugDose: 'text-amber-700',
          durationBg: 'bg-amber-100', durationText: 'text-amber-700', noteText: 'text-amber-600'
        },
        purple: {
          bg: 'bg-gradient-to-br from-purple-50 to-purple-100/50', border: 'border-purple-200', text: 'text-purple-800',
          drugBorder: 'border-purple-200', drugText: 'text-purple-800', drugDose: 'text-purple-700',
          durationBg: 'bg-purple-100', durationText: 'text-purple-700', noteText: 'text-purple-600'
        },
        slate: {
          bg: 'bg-gradient-to-br from-slate-50 to-slate-100/50', border: 'border-slate-200', text: 'text-slate-800',
          drugBorder: 'border-slate-200', drugText: 'text-slate-800', drugDose: 'text-slate-700',
          durationBg: 'bg-slate-100', durationText: 'text-slate-700', noteText: 'text-slate-600'
        }
      };
      return classMap[color] || classMap['slate'];
    }

    // Render disease detail
    function renderDiseaseDetail() {
      if (!selectedDisease || !selectedCategory) return;

      const category = diseases[selectedCategory];
      const disease = category.diseases.find(d => d.id === selectedDisease);
      if (!disease) return;

      welcomeScreen.classList.add('hidden');
      diseaseContent.classList.remove('hidden');

      const t = translations[currentLanguage];
      const tabs = [
        { id: 'epidemiology', label: t.tabs.epidemiology, icon: '📊' },
        { id: 'pathomechanism', label: t.tabs.pathomechanism, icon: '🔬' },
        { id: 'clinical', label: t.tabs.clinical, icon: '🩺' },
        { id: 'diagnostics', label: t.tabs.diagnostics, icon: '🧪' },
        { id: 'differential', label: t.tabs.differential, icon: '⚖️' },
        { id: 'therapy', label: t.tabs.therapy, icon: '💊' },
        { id: 'prognosis', label: t.tabs.prognosis, icon: '📈' }
      ];

      if (disease.gallery && disease.gallery.length > 0) {
        tabs.push({ id: 'gallery', label: t.tabs.gallery, icon: '🖼️' });
      }

      diseaseContent.innerHTML = `
        <div class="animate-fade-in">
          <!-- Header -->
          <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
            <div class="flex items-start gap-4">
              <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-white shadow-lg" style="background: ${category.color}">
                <span class="text-3xl">${category.icon}</span>
              </div>
              <div class="flex-1">
                <h1 class="font-serif-book text-2xl font-bold text-slate-800">${disease.name}</h1>
                <div class="flex flex-wrap items-center gap-2 mt-2">
                  <span class="pathogen-badge bg-slate-100 text-slate-700">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    ${disease.pathogen.name}
                  </span>
                  <span class="pathogen-badge bg-emerald-100 text-emerald-700">${disease.pathogen.type}</span>
                  <span class="pathogen-badge bg-violet-100 text-violet-700">${disease.pathogen.gram}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="border-b border-slate-200 bg-white sticky top-0 z-10">
            <div class="flex overflow-x-auto px-4 gap-1">
              ${tabs.map(tab => `
                <button onclick="changeTab('${tab.id}')" 
                  class="tab-btn flex items-center gap-2 px-4 py-3 text-sm whitespace-nowrap transition-all ${activeTab === tab.id ? 'active text-emerald-600 border-emerald-600' : 'text-slate-500 hover:text-slate-700 border-transparent'}" style="border-bottom-width: 3px;">
                  <span>${tab.icon}</span>
                  <span>${tab.label}</span>
                </button>
              `).join('')}
            </div>
          </div>

          <!-- Content -->
          <div class="p-6">
            ${renderTabContent(disease)}
          </div>
        </div>
      `;
    }

    // Render tab content
    function renderTabContent(disease) {
      const t = translations[currentLanguage];
      switch(activeTab) {
        case 'epidemiology':
          return `
            <div class="space-y-6">
              <div class="section-header" style="--before-bg: #10b981;">
                <h2 class="text-lg font-bold text-slate-800" style="::before { background: #10b981; }">${t.section_epidemiology}</h2>
              </div>
              
              <div class="grid gap-4 md:grid-cols-2">
                <div class="info-card p-4 rounded-xl bg-blue-50 border-blue-400">
                  <h3 class="font-semibold text-blue-800 mb-2">📊 ${t.label_incidence}</h3>
                  <p class="text-blue-700 text-sm leading-relaxed">${disease.epidemiology.incidence}</p>
                </div>
                
                <div class="info-card p-4 rounded-xl bg-amber-50 border-amber-400">
                  <h3 class="font-semibold text-amber-800 mb-2">📅 ${t.label_seasonality}</h3>
                  <p class="text-amber-700 text-sm">${disease.epidemiology.seasonality}</p>
                </div>
              </div>

              <div class="info-card p-4 rounded-xl bg-red-50 border-red-400">
                <h3 class="font-semibold text-red-800 mb-3">⚠️ ${t.label_risk_groups}</h3>
                <div class="flex flex-wrap gap-2">
                  ${(disease.epidemiology && disease.epidemiology.risk_groups ? disease.epidemiology.risk_groups : []).map(group => `
                    <span class="px-3 py-1.5 bg-white rounded-lg text-sm text-red-700 border border-red-200">${group}</span>
                  `).join('')}
                </div>
              </div>

              <div class="info-card p-4 rounded-xl bg-violet-50 border-violet-400">
                <h3 class="font-semibold text-violet-800 mb-2">🔄 ${t.label_transmission}</h3>
                <p class="text-violet-700 text-sm leading-relaxed">${disease.epidemiology.transmission}</p>
              </div>
            </div>
          `;

        case 'pathomechanism':
          return `
            <div class="space-y-6">
              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_pathomechanism}</h2>
              </div>

              <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-xl p-5 border border-violet-200">
                <h3 class="font-semibold text-violet-800 mb-4">🔬 ${t.label_pathogenesis_steps}</h3>
                <ol class="space-y-3">
                  ${(disease.pathomechanism && disease.pathomechanism.steps ? disease.pathomechanism.steps : []).map((step, index) => `
                    <li class="flex gap-3">
                      <span class="w-7 h-7 rounded-full bg-violet-600 text-white flex items-center justify-center text-sm font-bold flex-shrink-0">${index + 1}</span>
                      <span class="text-slate-700 text-sm leading-relaxed pt-0.5">${step}</span>
                    </li>
                  `).join('')}
                </ol>
              </div>

              <div class="bg-gradient-to-br from-rose-50 to-pink-50 rounded-xl p-5 border border-rose-200">
                <h3 class="font-semibold text-rose-800 mb-3">🦠 ${t.label_virulence_factors}</h3>
                <div class="flex flex-wrap gap-2">
                  ${(disease.pathomechanism && disease.pathomechanism.virulence_factors ? disease.pathomechanism.virulence_factors : []).map(factor => `
                    <span class="px-3 py-2 bg-white rounded-lg text-sm text-rose-700 border border-rose-200 shadow-sm">${factor}</span>
                  `).join('')}
                </div>
              </div>
            </div>
          `;

        case 'clinical':
          return `
            <div class="space-y-6">
              <div class="grid gap-4 md:grid-cols-3 mb-6">
                <div class="bg-slate-100 rounded-xl p-4 text-center">
                  <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">${t.label_incubation}</p>
                  <p class="font-semibold text-slate-800">${disease.clinical.incubation}</p>
                </div>
                <div class="bg-slate-100 rounded-xl p-4 text-center">
                  <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">${t.label_onset}</p>
                  <p class="font-semibold text-slate-800">${disease.clinical.onset}</p>
                </div>
                <div class="bg-red-100 rounded-xl p-4 text-center">
                  <p class="text-xs text-red-500 uppercase tracking-wider mb-1">${t.label_complications_count}</p>
                  <p class="font-semibold text-red-800">${disease.clinical.complications.length} ${t.label_types}</p>
                </div>
              </div>

              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_symptoms}</h2>
              </div>
              <div class="space-y-3">
                ${(disease.clinical && disease.clinical.symptoms ? disease.clinical.symptoms : []).map(symptom => `
                  <div class="bg-white p-4 rounded-xl border border-slate-200 flex items-start gap-4 hover:border-slate-300 transition-colors">
                    <div class="w-2.5 h-2.5 rounded-full ${getSeverityDotColor(symptom.severity)} flex-shrink-0 mt-1.5"></div>
                    <div class="flex-1">
                      <h4 class="font-semibold text-slate-800">${symptom.name}</h4>
                      <p class="text-sm text-slate-600">${symptom.description}</p>
                    </div>
                  </div>
                `).join('')}
              </div>

              <div class="section-header mt-8">
                <h2 class="text-lg font-bold text-slate-800">${t.section_physical_exam}</h2>
              </div>
              <div class="bg-emerald-50 rounded-xl p-5 border border-emerald-200">
                <ul class="space-y-2">
                    ${(disease.clinical && disease.clinical.physical_exam ? disease.clinical.physical_exam : []).map(finding => `
                    <li class="flex items-start gap-2 text-sm text-emerald-800">
                      <span class="text-emerald-600 mt-0.5">✓</span>
                      <span>${finding}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>

              <div class="section-header mt-8">
                <h2 class="text-lg font-bold text-slate-800">${t.section_complications}</h2>
              </div>
              <div class="flex flex-wrap gap-2">
                ${(disease.clinical && disease.clinical.complications ? disease.clinical.complications : []).map(comp => `
                  <span class="px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm border border-red-200">${comp}</span>
                `).join('')}
              </div>
            </div>
          `;

        case 'diagnostics':
          return `
            <div class="space-y-6">
              ${disease.diagnostics.criteria ? `
                <div class="section-header">
                  <h2 class="text-lg font-bold text-slate-800">${t.section_diagnostic_criteria}</h2>
                </div>
                <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
                  ${disease.diagnostics.criteria.map(c => `
                    <div class="mb-4 last:mb-0">
                      <h4 class="font-semibold text-slate-800 mb-2">${c.name}</h4>
                      <ul class="list-disc list-inside space-y-1 text-sm text-slate-700">
                        ${(c.items || []).map(item => `<li>${item}</li>`).join('')}
                      </ul>
                    </div>
                  `).join('')}
                </div>
              ` : ''}

              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_laboratory}</h2>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="bg-slate-100">
                      <th class="text-left p-3 font-semibold text-slate-700 rounded-tl-lg">${t.table_test}</th>
                      <th class="text-left p-3 font-semibold text-slate-700">${t.table_finding}</th>
                      <th class="text-left p-3 font-semibold text-slate-700 rounded-tr-lg">${t.table_interpretation}</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${disease.diagnostics.laboratory && disease.diagnostics.laboratory.length > 0 ? disease.diagnostics.laboratory.map((lab, index) => `
                      <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                        <td class="p-3 font-medium text-slate-800">${lab.test}</td>
                        <td class="p-3 text-blue-700">${lab.finding}</td>
                        <td class="p-3 text-slate-600">${lab.interpretation}</td>
                      </tr>
                    `).join('') : `<tr><td colspan="3" class="p-3 text-slate-500 text-center">${t.no_lab_tests}</td></tr>`}
                  </tbody>
                </table>
              </div>

              <div class="section-header mt-8">
                <h2 class="text-lg font-bold text-slate-800">${t.section_imaging}</h2>
              </div>
              <div class="grid gap-4 md:grid-cols-2">
                ${disease.diagnostics.imaging ? (disease.diagnostics.imaging || []).map(img => `
                  <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-4 border border-cyan-200">
                    <h4 class="font-semibold text-cyan-800">${img.modality}</h4>
                    <p class="text-cyan-700 text-sm mt-2">${img.finding}</p>
                    <p class="text-cyan-600 text-xs mt-2 italic">${img.significance}</p>
                  </div>
                `).join('') : `<p class="text-slate-500 text-sm">${t.no_imaging}</p>`}
              </div>

              <div class="section-header mt-8">
                <h2 class="text-lg font-bold text-slate-800">${t.section_microbiology}</h2>
              </div>
              <div class="space-y-3">
                ${disease.diagnostics.microbiology && disease.diagnostics.microbiology.length > 0 ? disease.diagnostics.microbiology.map(micro => `
                  <div class="bg-gradient-to-r from-violet-50 to-purple-50 rounded-xl p-4 border border-violet-200">
                    <div class="flex items-start gap-3">
                      <div class="w-10 h-10 bg-violet-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-white text-lg">🔬</span>
                      </div>
                      <div>
                        <h4 class="font-semibold text-violet-800">${micro.test}</h4>
                        <p class="text-violet-700 text-sm mt-1">${micro.finding}</p>
                        <p class="text-violet-600 text-xs mt-1 italic">${micro.significance}</p>
                      </div>
                    </div>
                  </div>
                `).join('') : `<p class="text-slate-500 text-sm">${t.no_microbiology}</p>`}
              </div>
            </div>
          `;

        case 'differential':
          const diffList = disease.differential || disease.diagnostics?.differential || [];
          return `
            <div class="space-y-6">
              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_differential}</h2>
              </div>
              <div class="space-y-4">
                ${diffList.length > 0 ? (diffList || []).map((diff, index) => `
                  <div class="bg-white rounded-xl border-2 border-slate-200 overflow-hidden hover:border-slate-300 transition-all">
                    <div class="flex items-center gap-4 p-4 bg-slate-50 border-b border-slate-200">
                      <span class="w-8 h-8 rounded-full bg-slate-700 text-white flex items-center justify-center font-bold text-sm">${index + 1}</span>
                      <h4 class="font-semibold text-slate-800">${diff.disease}</h4>
                    </div>
                    <div class="p-4">
                      <p class="text-sm text-slate-600">
                        <span class="font-medium text-slate-700">${t.label_distinguishing}</span>
                        ${diff.distinguishing}
                      </p>
                    </div>
                  </div>
                `).join('') : `<p class="text-slate-500 text-sm">${t.no_differential}</p>`}
              </div>
            </div>
          `;

        case 'therapy':
          return `
            <div class="space-y-6">
              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_empirical_therapy}</h2>
              </div>
              
              ${(() => {
                const therapyGroupDetails = {
                  cap_outpatient: { title: t.therapy_titles.cap_outpatient, icon: '🏠', color: 'green' },
                  cap_inpatient: { title: t.therapy_titles.cap_inpatient, icon: '🏥', color: 'blue' },
                  cap_icu: { title: t.therapy_titles.cap_icu, icon: '🚨', color: 'red' },
                  hap_early: { title: t.therapy_titles.hap_early, icon: '🏢', color: 'amber' },
                  hap_late_vap: { title: t.therapy_titles.hap_late_vap, icon: '🌬️', color: 'purple' },
                  outpatient: { title: t.therapy_titles.outpatient, icon: '🏠', color: 'green' },
                  inpatient: { title: t.therapy_titles.inpatient, icon: '🏥', color: 'blue' },
                  icu: { title: t.therapy_titles.icu, icon: '🚨', color: 'red' }
                };

                const groupsToRender = [];
                if (!disease.therapy.empirical) return '';

                Object.entries(disease.therapy.empirical).forEach(([key, value]) => {
                    if (Array.isArray(value) && value.length > 0) {
                        const details = therapyGroupDetails[key] || { icon: '💊', color: 'slate', title: t.therapy_titles.default };
                        groupsToRender.push({
                            key: key,
                            title: details.title,
                            drugs: value,
                            icon: details.icon,
                            color: details.color
                        });
                    } else if (value && value.drugs && value.drugs.length > 0) {
                        const details = therapyGroupDetails[key] || { icon: '💊', color: 'slate' };
                        groupsToRender.push({
                            key: key,
                            title: value.title || details.title || t.therapy_titles.default,
                            drugs: value.drugs,
                            icon: details.icon,
                            color: details.color
                        });
                    }
                });

                return groupsToRender.map(group => {
                  const colors = getTherapyColorClasses(group.color);
                  return `
                    <div class="${colors.bg} rounded-xl p-5 ${colors.border} mb-4">
                      <h3 class="font-semibold ${colors.text} mb-4 flex items-center gap-2">
                        <span class="text-xl">${group.icon}</span> ${group.title}
                      </h3>
                      <div class="space-y-3">
                        ${(group.drugs || []).map(drug => `
                          <div class="bg-white rounded-lg p-3 border ${colors.drugBorder}">
                            <div class="flex flex-wrap items-center gap-2">
                              <span class="font-semibold ${colors.drugText}">${drug.drug}</span>
                              <span class="${colors.drugDose}">${drug.dose}</span>
                              ${drug.duration ? `<span class="text-xs ${colors.durationBg} ${colors.durationText} px-2 py-0.5 rounded">${drug.duration}</span>` : ''}
                            </div>
                            ${drug.note ? `<p class="${colors.noteText} text-sm mt-1 italic">${drug.note}</p>` : ''}
                          </div>
                        `).join('')}
                      </div>
                    </div>
                `}).join('');
              })()}

              <div class="grid gap-4 md:grid-cols-2">
                <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-xl p-5 border border-violet-200">
                  <h3 class="font-semibold text-violet-800 mb-3 flex items-center gap-2">
                    <span class="text-xl">💪</span> ${t.label_supportive_therapy}
                  </h3>
                  <ul class="space-y-2">
                    ${(disease.therapy && disease.therapy.supportive ? disease.therapy.supportive : []).map(item => `
                      <li class="flex items-start gap-2 text-sm text-violet-700">
                        <span class="text-violet-500 mt-0.5">•</span>
                        <span>${item}</span>
                      </li>
                    `).join('')}
                  </ul>
                </div>

                <div class="bg-gradient-to-br from-teal-50 to-emerald-50 rounded-xl p-5 border border-teal-200">
                  <h3 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                    <span class="text-xl">🛡️</span> ${t.label_prevention}
                  </h3>
                  <ul class="space-y-2">
                    ${(disease.therapy && disease.therapy.prevention ? disease.therapy.prevention : []).map(item => `
                      <li class="flex items-start gap-2 text-sm text-teal-700">
                        <span class="text-teal-500 mt-0.5">•</span>
                        <span>${item}</span>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              </div>

              ${disease.therapy.guidelines ? `
                <div class="bg-gradient-to-br from-slate-50 to-gray-50 rounded-xl p-5 border border-slate-200 mt-4">
                  <h3 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                    <span class="text-xl">📚</span> ${t.label_guidelines}
                  </h3>
                  <ul class="space-y-2">
                    ${disease.therapy.guidelines.map(item => `
                      <li class="flex items-start gap-2 text-sm text-slate-700">
                        <span class="text-slate-500 mt-0.5">•</span>
                        <span>${item}</span>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          `;

        case 'prognosis':
          return `
            <div class="space-y-6">
              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_prognosis}</h2>
              </div>

              <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 text-white">
                <h3 class="font-semibold text-slate-200 mb-2">📊 ${t.label_mortality}</h3>
                <p class="text-2xl font-bold">${disease.prognosis.mortality}</p>
              </div>

              <div class="grid gap-4 md:grid-cols-2">
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border border-blue-200">
                  <h3 class="font-semibold text-blue-800 mb-3">📋 ${t.label_prognostic_scores}</h3>
                  <div class="flex flex-wrap gap-2">
                    ${(disease.prognosis && disease.prognosis.prognostic_scores ? disease.prognosis.prognostic_scores : []).map(score => `
                      <button onclick="openScoreCalculator('${score}')" class="px-3 py-1.5 bg-white rounded-lg text-sm text-blue-700 border border-blue-200 hover:bg-blue-50 transition-colors">${score}</button>
                    `).join('')}
                  </div>
                </div>

                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-5 border border-amber-200">
                  <h3 class="font-semibold text-amber-800 mb-3">⚠️ ${t.label_prognostic_factors}</h3>
                  <p class="text-amber-700 text-sm leading-relaxed">${disease.prognosis.factors}</p>
                </div>
              </div>
            </div>
          `;

        case 'gallery':
          return `
            <div class="space-y-6">
              <div class="section-header">
                <h2 class="text-lg font-bold text-slate-800">${t.section_gallery}</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${(disease.gallery || []).map(image => `
                  <a href="${image.url}" target="_blank" rel="noopener noreferrer" class="block group rounded-xl overflow-hidden border-2 border-slate-200 hover:border-emerald-400 hover:shadow-lg transition-all duration-300">
                    <div class="h-48 bg-slate-200 flex items-center justify-center overflow-hidden">
                      <img src="${image.url}" alt="${image.caption}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                    </div>
                    <div class="p-4 bg-white">
                      <p class="text-sm text-slate-700 font-medium">${image.caption}</p>
                      ${image.type ? `<span class="text-xs mt-2 inline-block px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full">${image.type}</span>` : ''}
                    </div>
                  </a>
                `).join('')}
              </div>
            </div>
          `;

        default:
          return '';
      }
    }

    // Search functionality
    searchInput.addEventListener('input', (e) => {
      const t = translations[currentLanguage];
      const query = e.target.value.toLowerCase();
      if (!query) {
        renderCategories();
        renderDiseaseList();
        return;
      }

      // Search across all diseases
      const results = [];
      Object.entries(diseases).forEach(([catKey, category]) => {
        category.diseases.forEach(disease => {
          if (disease.name.toLowerCase().includes(query) || 
              disease.pathogen.name.toLowerCase().includes(query)) {
            results.push({ ...disease, categoryKey: catKey, categoryName: category.name });
          }
        });
      });

      // Display results
      diseaseList.innerHTML = results.length ? results.map(disease => `
        <button onclick="selectCategory('${disease.categoryKey}'); selectDisease('${disease.id}')" 
          class="disease-card w-full text-left p-3.5 rounded-xl border border-slate-100 bg-white shadow-sm hover:border-emerald-200 transition-all group">
          <h3 class="font-semibold text-slate-800 text-sm group-hover:text-emerald-700 transition-colors">${disease.name}</h3>
          <p class="text-xs text-slate-500 mt-1 group-hover:text-slate-600 transition-colors">${disease.pathogen.name}</p>
          <p class="text-xs text-emerald-600 mt-1">${disease.categoryName}</p>
        </button>
      `).join('') : `<p class="text-slate-500 text-sm text-center py-8">${t.no_results}</p>`;
      
      categoryTitle.textContent = t.search_results;
      diseaseCount.textContent = `${results.length} találat`;
    });

    // Initialize
    function init() {
      // Load default language (HU)
      loadLanguageFiles('hu');
    }

    // Normalize disease objects at runtime so missing keys don't break templates
    function normalizeDiseases() {
      if (!window.diseases) return;
      Object.values(window.diseases).forEach(category => {
        (category.diseases || []).forEach(d => {
          d.clinical = d.clinical || {};
          d.clinical.symptoms = Array.isArray(d.clinical.symptoms) ? d.clinical.symptoms : [];
          d.clinical.physical_exam = Array.isArray(d.clinical.physical_exam) ? d.clinical.physical_exam : [];
          d.clinical.complications = Array.isArray(d.clinical.complications) ? d.clinical.complications : [];

          d.diagnostics = d.diagnostics || {};
          d.diagnostics.criteria = Array.isArray(d.diagnostics.criteria) ? d.diagnostics.criteria : [];
          d.diagnostics.laboratory = Array.isArray(d.diagnostics.laboratory) ? d.diagnostics.laboratory : [];
          d.diagnostics.imaging = Array.isArray(d.diagnostics.imaging) ? d.diagnostics.imaging : [];
          d.diagnostics.microbiology = Array.isArray(d.diagnostics.microbiology) ? d.diagnostics.microbiology : [];

          d.differential = Array.isArray(d.differential) ? d.differential : [];

          d.therapy = d.therapy || {};
          d.therapy.supportive = Array.isArray(d.therapy.supportive) ? d.therapy.supportive : [];
          d.therapy.prevention = Array.isArray(d.therapy.prevention) ? d.therapy.prevention : [];
          d.therapy.guidelines = Array.isArray(d.therapy.guidelines) ? d.therapy.guidelines : [];
          d.therapy.empirical = d.therapy.empirical || {};

          d.prognosis = d.prognosis || {};
          d.prognosis.prognostic_scores = Array.isArray(d.prognosis.prognostic_scores) ? d.prognosis.prognostic_scores : [];
          d.prognosis.factors = d.prognosis.factors || '';

          d.gallery = Array.isArray(d.gallery) ? d.gallery : [];
        });
      });
    }

    // Config change handler
    async function onConfigChange(newConfig) {
      config = { ...defaultConfig, ...newConfig };
      
      const titleEl = document.getElementById('main-title');
      const subtitleEl = document.getElementById('main-subtitle');
      
      if (titleEl) titleEl.textContent = config.app_title || defaultConfig.app_title;
      if (subtitleEl) subtitleEl.textContent = config.subtitle || defaultConfig.subtitle;
    }

    // Element SDK integration
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['app_title', cfg.app_title || defaultConfig.app_title],
          ['subtitle', cfg.subtitle || defaultConfig.subtitle]
        ])
      });
    }

    // Close modal on outside click
    document.getElementById('score-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeScoreModal();
        }
    });

    init();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</html>